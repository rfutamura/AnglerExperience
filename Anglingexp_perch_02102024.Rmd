---
title: "StudentCourse2024"
author: "Ryo FUTAMURA"
date: "2024-09-20"
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
always_allow_html: yes
---

```{r include=FALSE}
setwd("C:/Users/rfuta/OneDrive/発表/講義/IGBFishingClass/angling_experiment/")
```

```{r setup, warning=FALSE,message=FALSE}
##read needed packages
pacman::p_load(tidyverse,ggdist,readr,lmerTest,ggplotgui,car,performance,glmmTMB,readxl,scales,vegan, rstatix)
```

CPUE Analysis: CPUE difference between groups?
```{r individual-level data to CPUE data, warning=FALSE,message=FALSE}
## Read the data set of individual level
AnglingClass_data_perch <-read_xlsx("AnglingClass_fulldata.xlsx",sheet=3)

##this is how I calculated CPUE from individual level data using R###
CPUE_data_perch<-AnglingClass_data_perch%>% # individual level data
  dplyr::select(Year,Date, Site, Angler,Species, Fishing_experience,Species,Lure_color,
          Fishing_experience_score, Fishing_experience_standartized, Location, Session_ID,
          Duration_min)%>%
  mutate(id=row_number())%>%
  group_by(Year, Date, Angler, Site, Lure_color, 
           Fishing_experience, Fishing_experience_score, Fishing_experience_standartized, 
           Location,Session_ID,
           Duration_min) %>%
    summarise(N_zero = sum(Species== "NA", na.rm = TRUE),    
              N_fish = sum(id != "NA", na.rm = TRUE)-N_zero,
              CPUE=N_fish/Duration_min*30)%>% # Standard CPUE in 30 min
  mutate(N_fish=N_fish)%>%
  distinct()%>%
  dplyr::select(Year:Duration_min,N_zero, N_fish, CPUE)


```


```{r CPUE Analysis, warning=FALSE,message=FALSE}

##summary of data
summary(CPUE_data_perch$CPUE)
hist(CPUE_data_perch$CPUE)

## Negative binomial distribution if overdispersion
CPUE_model_perch_nb <- glm.nb(data = CPUE_data_perch,
                              N_fish ~ Fishing_experience*Lure_color+ offset(log(Duration_min)))

summary(CPUE_model_perch_nb)
Anova(CPUE_model_perch_nb)

sum(residuals(CPUE_model_perch_nb, type = "pearson")^2) / df.residual(CPUE_model_perch_nb)

CPUE_data_perch%>%
  group_by(Fishing_experience)%>%
  summarise(mean=mean(CPUE))


```


```{r plot of CPUE, warning=FALSE,message=FALSE}

# Create the violin plot
ggplot(CPUE_data_perch, aes(x = Fishing_experience, y = CPUE, fill = Fishing_experience)) +
  
  # Violin plot (distribution of data)
  geom_violin(
    width = 0.8,       # Controls the width of the violins
    alpha = 0.5,       # Transparency for the fill
    position = position_dodge(0.9),  # To separate violins between groups (if needed)
    trim = FALSE       # Do not trim the tails of the violins (shows full distribution)
  ) +
  
  # Optionally, add boxplot (summary statistics)
  geom_boxplot(
    width = 0.1,       # Slim boxplot inside the violins
    position = position_dodge(0.9),  # Ensure boxplots are aligned with violins
    outlier.shape = NA,  # Hide outliers (because we'll show actual points)
    alpha = 0.6
  ) +
  
  # Add jittered points (actual data points)
  geom_jitter(
    width = 0.05,       # Add jitter horizontally to prevent overlap
    size = 1.5,        # Adjust point size
    alpha = 0.1,       # Transparency for better visibility
    color = "black",   # Point color
  ) +
   # Add mean points
  stat_summary(
    fun = "mean",      # Use the mean for each group
    geom = "point",    # Plot points
    shape = 23,        # Change shape of the point (filled point)
    size = 3,          # Size of the point
    color = "black",   # Point outline color
    fill = "yellow",   # Point fill color
    position = position_dodge(0.9)  # Align mean points with violins
  ) +
  
  # Axis labels
  labs(x = "Fishing Experience", 
       y = "CPUE in 30 min") +
  
  # Customize theme for publication
  theme_bw(base_size = 14) +  # Increase base font size for clarity
  
  # Customize axis text and titles
  theme(
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold"),  # Facet labels
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Title centered
    legend.position = "none",
    panel.spacing = unit(1, "lines"),  # Add spacing between facets
    plot.margin = margin(1, 1, 1, 1, "cm")  # Increase margin around the plot
  ) +
  
  # Facet wrap for Year and Species
  facet_wrap(. ~ Year) +
  
  # Manually set fill colors for violins
  scale_fill_manual(values = c("grey", "grey")) +
  
  # Add cleaner gridlines
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

```
`
Individual level analysis
```{r individual level analysis (Fish size), warning=FALSE,message=FALSE}

## Read the data set of individual level
AnglingClass_perch_size_data<-AnglingClass_data_perch%>%
                          filter(Species!="NA")%>%
                          mutate(Length=as.numeric(Length),
                                 log_Length=log(Length))

#ggplot_shiny(AnglingClass_Individual_data)# might be good for exploration?

##shapiro-wilk test 
AnglingClass_perch_size_data %>%
  #group_by(Species) %>%
  shapiro_test(log_Length) # not normally distributed

###All species model

perch_size_model<-lm(log_Length ~ Fishing_experience*Lure_color+(1|Year),
                      data=AnglingClass_perch_size_data)


summary(All_size_model)
Anova(All_size_model)


## plot for publication
ggplot(AnglingClass_perch_size_data, aes(x = Fishing_experience, y = Length, fill = Fishing_experience)) +
  
  # Violin plot (distribution of data)
  geom_violin(
    width = 0.8,       # Controls the width of the violins
    alpha = 0.5,       # Transparency for the fill
    position = position_dodge(0.9),  # To separate violins between groups (if needed)
    trim = FALSE       # Do not trim the tails of the violins (shows full distribution)
  ) +
  
  # Optionally, add boxplot (summary statistics)
  geom_boxplot(
    width = 0.1,       # Slim boxplot inside the violins
    position = position_dodge(0.9),  # Ensure boxplots are aligned with violins
    outlier.shape = NA,  # Hide outliers (because we'll show actual points)
    alpha = 0.6
  ) +
  
  # Add jittered points (actual data points)
  geom_jitter(
    width = 0.05,       # Add jitter horizontally to prevent overlap
    size = 1.5,        # Adjust point size
    alpha = 0.2,       # Transparency for better visibility
    color = "black",   # Point color
  ) +
  
   # Add mean points
  stat_summary(
    fun = "mean",      # Use the mean for each group
    geom = "point",    # Plot points
    shape = 23,        # Change shape of the point (filled point)
    size = 3,          # Size of the point
    color = "black",   # Point outline color
    fill = "yellow",   # Point fill color
    position = position_dodge(0.9)  # Align mean points with violins
  ) +
  
  # Axis labels
  labs(x = "Fishing Experience", 
       y = "log(Fish size (mm))") +
  
  # Customize theme for publication
  theme_bw(base_size = 14) +  # Increase base font size for clarity
  
  # Customize axis text and titles
  theme(
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold"),  # Facet labels
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Title centered
    legend.position = "none",
    panel.spacing = unit(1, "lines"),  # Add spacing between facets
    plot.margin = margin(1, 1, 1, 1, "cm")  # Increase margin around the plot
  )+
  
  # Facet wrap for Year and Species
  facet_wrap(. ~ Year) +
  
  # Manually set fill colors for violins
  scale_fill_manual(values = c("grey", "grey")) +
  
  # Add cleaner gridlines
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

```

```{r individual level analysis (Bleeding), warning=FALSE,message=FALSE}
## Read the data set of individual level
AnglingClass_perch_bleeding_data<-AnglingClass_data_perch%>%
                      mutate(Bleeding=case_when(Bleeding=="YES"~1,
                                                 Bleeding=="NO"~0,
                                                    FALSE~NA))%>%
                      filter(!is.na(Bleeding))
                                 #only deal with species in both sites

#ggplot_shiny(AnglingClass_Individual_data)# might be good for exploration?

#GLMM full model
Full_model_perch_bleeding <- glm(data=AnglingClass_perch_bleeding_data,Bleeding ~ Fishing_experience * Lure_color,family =binomial(link = "logit"))

#model results
summary(Full_model_perch_bleeding)
Anova(Full_model_perch_bleeding) #type 2 wald tests.

#Create plot
#Fishing_experience and Bleeding
AnglingClass_perch_bleeding_data<- AnglingClass_perch_bleeding_data %>%
  mutate(Treatment_Experience_Bleeding = interaction(Fishing_experience, as.factor(Bleeding)))

# Calculate counts and percentages
perch_count_data_Bleeding <- AnglingClass_perch_bleeding_data%>%
  group_by(Fishing_experience,
           Treatment_Experience_Bleeding)%>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(Fishing_experience) %>%
  mutate(percent = count / sum(count))  


# Plot with manual colors for each treatment
ggplot(perch_count_data_Bleeding, aes(x = Fishing_experience, 
                                      fill = Treatment_Experience_Bleeding)) +
  geom_col(aes(y = percent), position = "fill", alpha = 0.7) + # Use geom_col to plot percentages
  scale_fill_manual(values = c("Experienced.0" = "steelblue", 
                                "Experienced.1" = "royalblue4", 
                                "Novice.0" = "darksalmon", 
                                "Novice.1" = "indianred4"), 
                    labels = c("Experienced.0" = "No Bleeding", 
                               "Experienced.1" = "Bleeding", 
                               "Novice.0" = "No Bleeding", 
                               "Novice.1" = "Bleeding"),
                    limits = c("Experienced.0", "Experienced.1", 
                               "Novice.0", "Novice.1")) +
  
  scale_y_continuous(labels = scales::percent) +
  theme_classic(base_size = 14) +
  geom_text(aes(y = percent,  # Map y aesthetic to percent
                label = scales::percent(percent, accuracy = 1)), 
            position = position_fill(vjust = 0.5), 
            size = 3) +
  xlab("Angling Experience") +
  ylab("Percent") +
  labs(fill = "")

```

```{r individual level analysis (hook depth), warning=FALSE,message=FALSE}
## Read the data set of individual level
AnglingClass_perch_hooking_data <-AnglingClass_data_perch%>%
                              mutate(Hooking_depth=case_when(Hooking_depth=="Verydeep"~1,
                                                             Hooking_depth=="Deep"~1,
                                                             Hooking_depth=="Shallow"~0,
                                                        FALSE~NA))%>%
                              filter(!is.na(Hooking_depth))

#GLMM full model
perch_model_hooking_depth<-glm(data=AnglingClass_perch_hooking_data,
                  Hooking_depth~Fishing_experience*Lure_color,
                     family = binomial(link = "logit"))

#check assumption
#check_model(full_model_hooking_depth)

#model results
summary(perch_model_hooking_depth)
Anova(perch_model_hooking_depth) #type 2 wald test.

##color plots
# Create a new variable that combines Fishing_experience and Bleeding
AnglingClass_perch_hooking_data<- AnglingClass_perch_hooking_data%>%
  mutate(Treatment_Experience_Hooking = interaction(Fishing_experience, as.factor(Hooking_depth)))

# Calculate counts and percentages
perch_count_data_hooking_depth <- AnglingClass_perch_hooking_data%>%
  group_by(Fishing_experience, Treatment_Experience_Hooking, Year) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(Fishing_experience, Year) %>%
  mutate(percent = count / sum(count))  # Calculate percentage for each treatment

# Plot with manual colors for each treatment
ggplot(perch_count_data_hooking_depth, aes(x = Fishing_experience, 
                                      fill = Treatment_Experience_Hooking)) +
  geom_col(aes(y = percent), position = "fill", alpha = 0.7) + # Use geom_col to plot percentages
  scale_fill_manual(values = c("Experienced.0" = "steelblue", 
                                "Experienced.1" = "royalblue4", 
                                "Novice.0" = "darksalmon", 
                                "Novice.1" = "indianred4"), 
                    labels = c("Experienced.0" = "Shallow - Experienced", 
                               "Experienced.1" = "Deep - Experienced", 
                               "Novice.0" = "Shallow - Novice", 
                               "Novice.1" = "Deep - Novice"),
                    limits = c("Experienced.0", "Experienced.1", 
                               "Novice.0", "Novice.1") )+
  
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(. ~ Year) +
  theme_classic(base_size = 14) +
  geom_text(aes(y = percent,  # Map y aesthetic to percent
                label = scales::percent(percent, accuracy = 1)), 
            position = position_fill(vjust = 0.5), 
            size = 3) +
  xlab("Angling Experience") +
  ylab("Percent") +
  labs(fill = "")


```
