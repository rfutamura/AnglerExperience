---
title: "StudentCourse2024"
author: "Ryo FUTAMURA"
date: "2024-09-20"
output:
  html_document:
    code_folding: hide
    theme: united
    toc: yes
    toc_float: yes
always_allow_html: yes
---

```{r include=FALSE}
#setwd("X:/Biologie der Fische, Fischerei und Aquakultur/Arlinghaus/Sampling_2024/coding")
setwd("C:/Users/rfuta/OneDrive/発表/講義/IGBFishingClass/angling_experiment/")

```

```{r setup, warning=FALSE,message=FALSE}
##read needed packages
pacman::p_load(tidyverse,ggdist,readr,lmerTest,ggplotgui,car,performance,glmmTMB,readxl,scales,vegan, rstatix)
```

# data preaparation CPUE
```{r data preparation individual-level data to CPUE data, warning=FALSE,message=FALSE}

## Read the data set of individual level
AnglingClass_data <- read_xlsx("AnglingClass_fulldata.xlsx",sheet=1)%>%
   mutate(Date=as.Date(Date))%>%
   mutate(log_Length=log(Length))%>%
   mutate(Fishing_experience_adjusted=as.factor(round(Fishing_experience_adjusted)),#roll
          Fishing_category=case_when(Year==2011&Fishing_experience_score>=12~"Experienced",
                                    Year==2020&Fishing_experience_score>=11~"Experienced",
                                    Year==2024&Fishing_experience_score>=17~"Experienced",
                                    TRUE~"Novice"))%>%
                    mutate(Fishing_experience_adjusted=as.numeric(Fishing_experience_adjusted))


##calculated CPUE from individual level data using R###
Angling_CPUE_data<-AnglingClass_data%>% # individual level data
  dplyr::select(Year,Date, Date_ID, Site, Angler,Angler_ID,Spot_ID,
          Hook_size,  Hook_size_quant,Species, Fishing_experience,Species, Location,
          Fishing_experience_score, Fishing_experience_adjusted,Fishing_category, Session_ID,
          Duration_min)%>%
  mutate(id=row_number())%>%
  group_by(Year, Date, Date_ID,Spot_ID, Angler, Angler_ID, Site, 
           Hook_size,Hook_size_quant, Fishing_experience, Fishing_experience_score, Fishing_experience_adjusted,Fishing_category, 
           Location,Session_ID,
           Duration_min) %>%
    summarise(N_zero = sum(Species== "NA", na.rm = TRUE),    
              N_fish = sum(id != "NA", na.rm = TRUE)-N_zero,
              CPUE=N_fish/Duration_min*30)%>% # Standard CPUE in 30 min
  distinct()%>%
  dplyr::select(Year:Duration_min,N_zero, N_fish, CPUE)

write.csv(Angling_CPUE_data, "CPUE.csv") #add to the other dataset

```


# Descriptive data Species
```{r species composition, warning=FALSE,message=FALSE}
Species_data<-AnglingClass_data%>%
            filter(Species!="NA")

table(Species_data$Year,
      Species_data$Species)


table(Species_data$Year,
      Species_data$Fishing_experience,
      Species_data$Species)


#Chi-square test applied to each years..
Surv_year<-c(2011,2020,2024)


for (i in Surv_year) {
  
  Species_data_i<-Species_data%>%
                filter(Year==i)
  
    print(paste0("Year is ", i))
  print(chisq.test(table(Species_data_i$Fishing_category,
                         Species_data_i$Species)))
 
}


################plot the data#############################
Spp_summary<-Species_data %>%
  group_by(Year,Fishing_category, Species) %>%
  summarise(counts = n())%>%
  arrange(desc(Species)) %>%
  mutate(prop = round(counts*100/sum(counts), 1),
         lab.ypos = cumsum(prop) - 0.5*prop)


# Create publication-ready pie chart
ggplot(Spp_summary, aes(x = "", y = prop, fill = Species)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) +
  facet_wrap(. ~ Year + Fishing_category, ncol = 2) +
  theme_void() +  # Keeps the chart clean without gridlines or axes
  theme(
    strip.text = element_text(size = 12, face = "bold"),  # Facet label font size and style
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),  # Centered plot title
    legend.position = "right",  # Move the legend to the right
    legend.title = element_text(size = 12, face = "bold"),  # Legend title styling
    legend.text = element_text(size = 10)  # Legend text size
  ) +
  ggpubr::fill_palette("jco")


```

# Analysis for hypothesis 1,3
```{r CPUE Analysis, warning=FALSE,message=FALSE}
## full data set of CPUE
Angling_CPUE_data <- read_xlsx("AnglingClass_fulldata.xlsx",sheet=2)%>%
                    mutate(Fishing_experience_adjusted=as.numeric(Fishing_experience_adjusted),
                           Session_ID=as.numeric(Session_ID))
#sub model of CPUE
Angling_CPUE_data_restricted<-Angling_CPUE_data %>%
  mutate(Date = as.Date(as.numeric(Date), origin = "1899-12-30"))%>%
                   filter(!Date %in%  ymd(c("2020-09-02", 
                                            "2020-09-03"))) #remove days with same hook

########analysis part############
## Negative binomial distribution full model
Full_CPUE_model_nb <- glmmTMB(N_fish~
                             Fishing_experience_adjusted*Session_ID+
                             Date_ID*Fishing_experience_adjusted+
                             (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                             family = nbinom2, data = Angling_CPUE_data)

sum(residuals(Full_CPUE_model_nb, type = "pearson")^2) / df.residual(Full_CPUE_model_nb)

summary(Full_CPUE_model_nb)
Anova(Full_CPUE_model_nb)

##Negative binomial distribution sub model
Sub_CPUE_model_nb <- glmmTMB(N_fish~
                             Fishing_experience_adjusted*Hook_size+Fishing_experience_adjusted*Session_ID+
                             Date_ID*Fishing_experience_adjusted+
                             (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                             family = nbinom2, 
                             data = Angling_CPUE_data_restricted)

summary(Sub_CPUE_model_nb)
Anova(Sub_CPUE_model_nb)

```

# plot for Hypothsis 1,3
```{r plot of CPUE, warning=FALSE,message=FALSE}
# Create the violin plot
Forplotting_Angling_CPUE_data<-Angling_CPUE_data%>%
  mutate(Fishing_experience_adjusted=as.factor(round(Fishing_experience_adjusted)))

#split angling experience by median
AnglingClass_data%>%
  group_by(Year)%>%
  summarise(median=median(Fishing_experience_score))

##boxplot Experienced vs. Noviced

## Rolled category
ggplot(Forplotting_Angling_CPUE_data, aes(x = as.factor(Fishing_experience_adjusted), y = CPUE, fill = as.factor(Fishing_experience_adjusted), color = as.factor(Fishing_experience_adjusted))) +
  
  # Violin plot (distribution of data)
  geom_violin(
    fill="grey90",
    color="grey90",
    alpha = 0.5,                     # Transparency for the fill
    position = position_dodge(0.9),   # To separate violins between groups (if needed)
    trim = FALSE                      # Show full distribution without trimming
  ) +
  
  # Add boxplot (summary statistics)
  geom_boxplot(
    fill="grey30",
    color="grey30",
    width = 0.1,                      # Slim boxplot inside the violins
    position = position_dodge(0.9),   # Ensure boxplots are aligned with violins
    outlier.shape = NA,               # Hide outliers
    alpha = 0.6
  ) +
  
  # Add jittered points (actual data points)
  geom_jitter(
    width = 0.05,                     # Jitter to prevent overlap
    size = 1.5,                       # Adjust point size
    alpha = 0.4,                      # Transparency for better visibility
    color = "black",                  # Point color
  ) +
  
  # Add mean points
  stat_summary(
    fun = "mean",                     # Mean for each group
    geom = "point",                   # Plot points
    shape = 23,                       # Change shape of the point
    size = 3,                         # Size of the point
    color = "black",                  # Point outline color
    fill = "black",                  # Point fill color
    position = position_dodge(0.9)    # Align mean points with violins
  ) +
  
  # Axis labels
  labs(x = "Fishing Experience (Adjusted)", 
       y = "CPUE in 30 min") +
  
  # Customize theme for publication
  theme_bw(base_size = 14) +          # Increase base font size
  
  # Customize axis text and titles
  theme(
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold"),   # Facet labels
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"), # Title centered
    legend.position = "none",         # Remove legend for cleaner look
    panel.spacing = unit(1, "lines"), # Add spacing between facets
    plot.margin = margin(1, 1, 1, 1, "cm")  # Add margin around plot
  ) +
  
  # Facet wrap for Year and potentially Species
  facet_wrap(. ~ Year) +
  
  # Cleaner gridlines
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())



##boxplot recategorised
ggplot(Forplotting_Angling_CPUE_data, aes(x = Fishing_experience, y = CPUE,fill=Fishing_experience)) +
  
  # Violin plot (distribution of data)
  geom_violin(
    color="grey90",
    width = 0.8,       # Controls the width of the violins
    alpha = 0.5,       # Transparency for the fill
    position = position_dodge(0.9),  # To separate violins between groups (if needed)
    trim = FALSE       # Do not trim the tails of the violins (shows full distribution)
  ) +
  
  # Optionally, add boxplot (summary statistics)
  geom_boxplot(
    width = 0.1,       # Slim boxplot inside the violins
    position = position_dodge(0.9),  # Ensure boxplots are aligned with violins
    outlier.shape = NA,  # Hide outliers (because we'll show actual points)
    alpha = 0.6
  ) +
  
  # Add jittered points (actual data points)
  geom_jitter(
    width = 0.05,       # Add jitter horizontally to prevent overlap
    size = 1.5,        # Adjust point size
    alpha = 0.1,       # Transparency for better visibility
    color = "black",   # Point color
  ) +
   # Add mean points
  stat_summary(
    fun = "mean",      # Use the mean for each group
    geom = "point",    # Plot points
    shape = 23,        # Change shape of the point (filled point)
    size = 3,          # Size of the point
    color = "black",   # Point outline color
    fill = "white",   # Point fill color
    position = position_dodge(0.9)  # Align mean points with violins
  ) +
  
  # Axis labels
  labs(x = "Fishing Experience", 
       y = "CPUE in 30 min") +
  
  # Customize theme for publication
  theme_bw(base_size = 14) +  # Increase base font size for clarity
  
  # Customize axis text and titles
  theme(
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold"),  # Facet labels
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Title centered
    legend.position = "none",
    panel.spacing = unit(1, "lines"),  # Add spacing between facets
    plot.margin = margin(1, 1, 1, 1, "cm")  # Increase margin around the plot
  ) +
  
  # Facet wrap for Year and Species
  facet_wrap(. ~ Year) +
  
  # Manually set fill colors for violins
  scale_fill_manual(values = c("grey80", "grey80")) +
  
  # Add cleaner gridlines
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

```

#Descriptive data
```{r No. Species}
# ##this is how I calculated CPUE from individual level data using R###
# Species_data<-AnglingClass_data%>% # individual level data
#   dplyr::select(Year,Date, Site, Angler,
#           Hook_size,  Hook_size_quant,Species, Fishing_experience,Species,
#           Fishing_experience_score, Fishing_experience_standartized, Location, Session_ID,
#           Duration_min)%>%
#   distinct()%>%
#   mutate(id=row_number())%>%
#   group_by(Year, Date, Angler, Site,
#            Hook_size,Hook_size_quant, Fishing_experience, Fishing_experience_score, Fishing_experience_standartized, 
#            Location,Session_ID,
#            Duration_min) %>%
#     summarise(N_sp_0 = sum(Species== "NA", na.rm = TRUE),    
#               N_species = sum(id != "NA", na.rm = TRUE),
#               N_species_std=(N_species)/Duration_min*30)%>% # Standard in 30 min
#      distinct()
# 
# 
# ####################modeling part for species caught###
# Species_model<-glmer(data=Species_data,
# N_species~Fishing_experience*Hook_size+
#                          (1|Year), offset =(log(Duration_min)),
#                          family = poisson(link="log"))
# 
# summary(Species_model)
# Anova(Species_model)
# 

# Species_model_restricted<-glmer(data=Species_data %>%
#                    mutate(Date=as.Date(Date))%>%
#                   filter(!Date %in%  ymd(c("2020-09-02", 
#                                            "2020-09-03"))),
# N_species~Fishing_experience*Hook_size+
#                          (1|Year), offset =(log(Duration_min)),
#                          family = poisson(link="log"))
# 
# summary(Species_model_restricted)
# Anova(Species_model_restricted)



# sum(residuals(Species_model, type = "pearson")^2) / df.residual(Species_model)
# 
# ################plot the data#############################
# #summarise data to get CPUE per 30 min
# Spp_summary <- Species_data %>%
#   group_by(Fishing_experience,Year) %>%
#   summarize(mean_spp = mean(N_species, na.rm = TRUE),
#             se_spp = sd(N_species, na.rm = TRUE) / sqrt(n()),
#             .groups = 'drop')
# 
# # Create the violin plot
# ggplot(Species_data, aes(x = Fishing_experience, y = N_species_std, fill = Fishing_experience)) +
#   
#   # Violin plot (distribution of data)
#   geom_violin(
#     width = 0.8,       # Controls the width of the violins
#     alpha = 0.5,       # Transparency for the fill
#     position = position_dodge(0.9),  # To separate violins between groups (if needed)
#     trim = FALSE       # Do not trim the tails of the violins (shows full distribution)
#   ) +
#   
#   # Optionally, add boxplot (summary statistics)
#   geom_boxplot(
#     width = 0.1,       # Slim boxplot inside the violins
#     position = position_dodge(0.9),  # Ensure boxplots are aligned with violins
#     outlier.shape = NA,  # Hide outliers (because we'll show actual points)
#     alpha = 0.6
#   ) +
#   
#   # Add jittered points (actual data points)
#   geom_jitter(
#     width = 0.05,       # Add jitter horizontally to prevent overlap
#     size = 1.5,        # Adjust point size
#     alpha = 0.2,       # Transparency for better visibility
#     color = "grey10",   # Point color
#   ) +
# 
#    # Add mean points
#   stat_summary(
#     fun = "mean",      # Use the mean for each group
#     geom = "point",    # Plot points
#     shape = 23,        # Change shape of the point (filled point)
#     size = 3,          # Size of the point
#     color = "black",   # Point outline color
#     fill = "yellow",   # Point fill color
#     position = position_dodge(0.9)  # Align mean points with violins
#   ) +
#   
#   # Axis labels
#   labs(x = "Fishing Experience", 
#        y = "Number of species in 30 min") +
#   
#   # Customize theme for publication
#   theme_bw(base_size = 14) +  # Increase base font size for clarity
#   
#   # Customize axis text and titles
#   theme(
#     axis.title = element_text(face = "bold", size = 14),
#     axis.text = element_text(size = 12),
#     strip.text = element_text(size = 14, face = "bold"),  # Facet labels
#     plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Title centered
#     legend.position = "none",
#     panel.spacing = unit(1, "lines"),  # Add spacing between facets
#     plot.margin = margin(1, 1, 1, 1, "cm")  # Increase margin around the plot
#   ) +
#   
#   # Facet wrap for Year and Species
#   facet_wrap(. ~ Year) +
#   
#   # Manually set fill colors for violins
#   scale_fill_manual(values = c("royalblue2", "indianred")) +
#   
#   # Add cleaner gridlines
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank())
```

# Descriptive data
```{r individual level analysis (Fish size), warning=FALSE,message=FALSE}

## full data set for size analysis
AnglingClass_size_data <-AnglingClass_data

##shapiro-wilk test 
# AnglingClass_size_data %>%
# group_by(Species) %>%
# shapiro_test(Length) # not normally distributed

## sub-model for the size analysis
AnglingClass_size_data_restricted <-AnglingClass_size_data%>%
   filter(!Date %in%  ymd(c("2020-09-02", "2020-09-03"))) #remove days with same hook


### FUll model for size analysis
Full_size_model<-lmer(log_Length~Fishing_experience_adjusted+Session_ID+
                             Date_ID*Fishing_experience_adjusted+
                             (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                      data=AnglingClass_size_data)

summary(Full_size_model)
Anova(Full_size_model)


##sub model for size analysis
Sub_size_model<-lmer(log_Length ~Fishing_experience_adjusted*Hook_size+Session_ID+
                             Date_ID*Fishing_experience_adjusted+
                             (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                      data=AnglingClass_size_data_restricted)

summary(Sub_size_model)
Anova(Sub_size_model)



#########Removal of large individuals-Bream
### FUll model for size analysis
Full_size_model_removed<-lmer(log_Length~Fishing_experience_adjusted+Session_ID+
                             Date_ID*Fishing_experience_adjusted+
                             (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                      data=AnglingClass_size_data%>%filter(Species!="Bream"))

summary(Full_size_model_removed)
Anova(Full_size_model_removed)


##sub model for size analysis
Sub_size_model_removed<-lmer(log_Length ~Fishing_experience_adjusted*Hook_size+Session_ID+
                             Date_ID*Fishing_experience_adjusted+
                             (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                      data=AnglingClass_size_data_restricted%>%filter(Species!="Bream"))

summary(Sub_size_model_removed)
Anova(Sub_size_model_removed)
##########################


######plotting########
## plot for publication?
ggplot(AnglingClass_size_data, aes(x =  Fishing_category, y = Length, fill =  Fishing_category)) +
  
  # Violin plot (distribution of data)
  geom_violin(
    width = 0.8,       # Controls the width of the violins
    alpha = 0.5,       # Transparency for the fill
    position = position_dodge(0.9),  # To separate violins between groups (if needed)
    trim = FALSE       # Do not trim the tails of the violins (shows full distribution)
  ) +
  
  # Optionally, add boxplot (summary statistics)
  geom_boxplot(
    width = 0.1,       # Slim boxplot inside the violins
    position = position_dodge(0.9),  # Ensure boxplots are aligned with violins
    outlier.shape = NA,  # Hide outliers (because we'll show actual points)
    alpha = 0.6
  ) +
  
  # Add jittered points (actual data points)
  geom_jitter(
    width = 0.05,       # Add jitter horizontally to prevent overlap
    size = 1.5,        # Adjust point size
    alpha = 0.2,       # Transparency for better visibility
    color = "black",   # Point color
  ) +
  
   # Add mean points
  stat_summary(
    fun = "mean",      # Use the mean for each group
    geom = "point",    # Plot points
    shape = 23,        # Change shape of the point (filled point)
    size = 3,          # Size of the point
    color = "black",   # Point outline color
    fill = "white",   # Point fill color
    position = position_dodge(0.9)  # Align mean points with violins
  ) +
  
  # Axis labels
  labs(x = "Fishing Experience", 
       y = "log(Fish size (mm))") +
  
  # Customize theme for publication
  theme_bw(base_size = 14) +  # Increase base font size for clarity
  
  # Customize axis text and titles
  theme(
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 12),
    strip.text = element_text(size = 14, face = "bold"),  # Facet labels
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),  # Title centered
    legend.position = "none",
    panel.spacing = unit(1, "lines"),  # Add spacing between facets
    plot.margin = margin(1, 1, 1, 1, "cm")  # Increase margin around the plot
  )+
  
  # Facet wrap for Year and Species
  facet_wrap(. ~ Year) +
  
  # Manually set fill colors for violins
  scale_fill_manual(values = c("grey90", "grey90")) +
  
  # Add cleaner gridlines
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

```

#Analysis and plot for Hypothesis 2 and 4
```{r individual level analysis (Bleeding), warning=FALSE,message=FALSE}
## Read the data set of individual level

###Full data
AnglingClass_bleeding_data <-AnglingClass_data%>%
                        mutate(Bleeding=case_when(Bleeding=="YES"~1,
                                                        Bleeding=="NO"~0,
                                                        FALSE~NA))%>%
                        filter(!is.na(Bleeding))

##Restricted data
AnglingClass_bleeding_data_restricted <-AnglingClass_bleeding_data %>%
                                  filter(!Date %in%  ymd(c("2020-09-02", "2020-09-03")))
   
###########analysis part################                          
#GLMM full model
Full_model_bleeding<-glmer(data=AnglingClass_bleeding_data,
                       Bleeding~Fishing_experience_adjusted+
                                (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                                     family = binomial(link = "logit"))

summary(Full_model_bleeding)
Anova(Full_model_bleeding)

#Sub model
Sub_model_bleeding<-glmer(data=AnglingClass_bleeding_data,
                       Bleeding~Fishing_experience_adjusted*Hook_size+
                                (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                                family = binomial(link = "logit"))

summary(Sub_model_bleeding)
Anova(Sub_model_bleeding)



### Full model for each years
#2011
Full_model_bleeding_11<-glmer(data=AnglingClass_bleeding_data%>%
                            filter(Year=="2011"),
                       Bleeding~Fishing_experience_adjusted+(1|Angler_ID), #one year one location
                                     family = binomial(link = "logit"))

summary(Full_model_bleeding_11)
Anova(Full_model_bleeding_11)


#2020 and 2024
Full_model_bleeding_20_24<-glmer(data=AnglingClass_bleeding_data%>%
                                       filter(Year %in% c("2020", "2024")),
                                 Bleeding~Fishing_experience_adjusted+
                                (1|Year)+(1|Angler_ID),
                                     family = binomial(link = "logit"))

summary(Full_model_bleeding_20_24)
Anova(Full_model_bleeding_20_24)


##sub model for each year
Sub_model_bleeding_11<-glmer(data=AnglingClass_bleeding_data%>%
                            filter(Year=="2011"),
                       Bleeding~Fishing_experience_adjusted*Hook_size+
                                (1|Angler_ID),
                                     family = binomial(link = "logit"))

summary(Sub_model_bleeding_11)
Anova(Sub_model_bleeding_11)


#2020 and 2024
Sub_model_bleeding_20_24<-glmer(data=AnglingClass_bleeding_data%>%
                            filter(Year %in% c("2020", "2024")),
                       Bleeding~Fishing_experience_adjusted*Hook_size+
                                (1|Year)+(1|Angler_ID),
                                     family = binomial(link = "logit"))

summary(Sub_model_bleeding_20_24)
Anova(Sub_model_bleeding_20_24)

##################Plot the data##############################
#Fishing experience difference of Bleeding
ggplot(AnglingClass_bleeding_data, aes(x = Hook_size,
                                         color = as.factor(Bleeding),
                                         fill = as.factor(Bleeding))) +
  geom_bar(position = "fill")+
  facet_wrap(.~Year)


# Create a new variable that combines Fishing_experience and Bleeding

# Calculate counts and percentages
count_data_Bleeding <- AnglingClass_bleeding_data%>%
  group_by(Fishing_category, Bleeding, Year) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(Fishing_category, Year) %>%
  mutate(percent = count / sum(count))  # Calculate percentage for each treatment


###Plot for each year
ggplot(count_data_Bleeding, aes(x = Fishing_category, 
                                      fill = as.factor(Bleeding))) +  # Ensure Hooking_depth is a factor
  geom_col(aes(y = percent), position = "fill", alpha = 0.7, color = "black") +  # Stacked bars
  
  # Manual fill colors for "Hooking_depth"
  scale_fill_manual(values = c("0" = "grey90", "1" = "black"), 
                    labels = c("0" = "No", "1" = "Yes")) +
  
  # Convert y-axis to percent format
  scale_y_continuous(labels = scales::percent_format()) +
  
  # Facet the plot by "Year"
  facet_wrap(. ~ Year) +
  
  # Classic theme for a cleaner look
  theme_classic(base_size = 14) +
  
  # Add percentage labels inside the bars
  geom_text(aes(y = percent,  # Map y aesthetic to percent for text placement
                label = scales::percent(percent, accuracy = 1)), 
            position = position_fill(vjust = 0.5),  # Position text inside the bars
            size = 3) +  # Adjust text size
  
  # Customize axis labels
  xlab("Angling Experience") +
  ylab("Percent") +
  
  # Remove legend title (empty string)
  labs(fill = "")

```

#Hypothesis 2 and 4
```{r individual level analysis (hook depth), warning=FALSE,message=FALSE}
## full data for the 
AnglingClass_hooking_data <-AnglingClass_data%>%
                       mutate(Hooking_depth=case_when(Hooking_depth=="Verydeep"~1,
                                                             Hooking_depth=="Deep"~1,
                                                             Hooking_depth=="Shallow"~0,
                                                        FALSE~NA))%>%
                       filter(!is.na(Hooking_depth))


#Restricted data 
AnglingClass_hooking_data_restricted<-AnglingClass_hooking_data%>%
                       filter(!Date %in%  ymd(c("2020-09-02", "2020-09-03")))
                                      

###########analysis part################   
#GLMM full model
Full_model_hooking<-glmer(data=AnglingClass_hooking_data,
                       Hooking_depth~Fishing_experience_adjusted+
                                Date_ID*Fishing_experience_adjusted+
                                (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                                     family = binomial(link = "logit"))

summary(Full_model_hooking)
Anova(Full_model_hooking)

#Sub model
Sub_model_hooking_restricted<-glmer(data=AnglingClass_hooking_data_restricted,
                       Hooking_depth~Fishing_experience_adjusted*Hook_size+
                                (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                                family = binomial(link = "logit"))

summary(Sub_model_hooking_restricted)
Anova(Sub_model_hooking_restricted)



### Full model for each years
#2011
Full_model_hooking_11<-glmer(data=AnglingClass_hooking_data%>%
                            filter(Year=="2011"),
                       Hooking_depth~Fishing_experience_adjusted+
                         (1|Angler_ID)+(1|Spot_ID),
                           family = binomial(link = "logit"))

summary(Full_model_hooking_11)
Anova(Full_model_hooking_11)


#2020 and 2024
Full_model_hooking_20_24<-glmer(data=AnglingClass_hooking_data%>%
                            filter(Year %in% c("2020", "2024")),
                       Hooking_depth~Fishing_experience_adjusted+
                                (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                                     family = binomial(link = "logit"))

summary(Full_model_hooking_20_24)
Anova(Full_model_hooking_20_24)


##sub model for each year
Sub_model_hooking_11<-glmer(data=AnglingClass_hooking_data_restricted%>%
                            filter(Year=="2011"),
                       Hooking_depth~Fishing_experience_adjusted*Hook_size+
                                (1|Angler_ID)+(1|Spot_ID),
                                     family = binomial(link = "logit"))

summary(Sub_model_hooking_11)
Anova(Sub_model_hooking_11)


#2020 and 2024
Sub_model_hooking_20_24<-glmer(data=AnglingClass_hooking_data_restricted%>%
                            filter(Year %in% c("2020", "2024")),
                       Hooking_depth~Fishing_experience_adjusted*Hook_size+
                                (1|Year)+(1|Angler_ID)+(1|Spot_ID),
                                     family = binomial(link = "logit"))

summary(Sub_model_hooking_20_24)
Anova(Sub_model_hooking_20_24)


###########plotting part################
## Plotting Fishing experience difference of hooking depth
# Calculate counts and percentages
count_data_hooking_depth <- AnglingClass_hooking_data%>%
  group_by(Fishing_category, Hooking_depth, Year) %>%
  summarise(count = n(), .groups = 'drop') %>%
  group_by(Fishing_category, Year) %>%
  mutate(percent = count / sum(count))  # Calculate percentage for each treatment


###Plot for each year
ggplot(count_data_hooking_depth, aes(x = Fishing_category, 
                                      fill = as.factor(Hooking_depth))) +  # Ensure Hooking_depth is a factor
  geom_col(aes(y = percent), position = "fill", alpha = 0.7, color = "black") +  # Stacked bars
  
  # Manual fill colors for "Hooking_depth"
  scale_fill_manual(values = c("0" = "grey90", "1" = "black"), 
                    labels = c("0" = "No", "1" = "Yes")) +
  
  # Convert y-axis to percent format
  scale_y_continuous(labels = scales::percent_format()) +
  
  # Facet the plot by "Year"
  facet_wrap(. ~ Year) +
  
  # Classic theme for a cleaner look
  theme_classic(base_size = 14) +
  
  # Add percentage labels inside the bars
  geom_text(aes(y = percent,  # Map y aesthetic to percent for text placement
                label = scales::percent(percent, accuracy = 1)), 
            position = position_fill(vjust = 0.5),  # Position text inside the bars
            size = 3) +  # Adjust text size
  
  # Customize axis labels
  xlab("Angling Experience") +
  ylab("Percent") +
  
  # Remove legend title (empty string)
  labs(fill = "")


```

```{r plots for some testing}
#easy way to Visualize
#Viaualize angling skills 
# ggplot(data=AnglingClass_data, aes(x=Fishing_experience_standartized,fill=as.factor(Year)))+
#      geom_histogram()
# 
# ggplot(data=AnglingClass_data, aes(x=Fishing_experience_adjusted,fill=as.factor(Year)))+
#      geom_histogram()
# 
# ggplot(data=AnglingClass_data, aes(x=Fishing_experience_score,fill=as.factor(Year)))+
#      geom_histogram()
# 


#plots and several things
#easy one
ggplot(AnglingClass_hooking_data, aes(x = Fishing_experience,
                                         color = as.factor(Hooking_depth),
                                         fill = as.factor(Hooking_depth))) +
  geom_bar(position = "fill")+
  facet_wrap(.~Year)


#easy one
ggplot(AnglingClass_hooking_data, aes(x = Fishing_experience_adjusted,y=Hooking_depth,
                                         color = as.factor(Year),
                                         fill = as.factor(Year))) +
  geom_point()+
  geom_smooth(method = "glm", method.args = list(family = "binomial")) 
  

# sjPlot::plot_model(full_model_hooking_depth2, type = "pred",
#                    terms = c("Fishing_experience_adjusted", "Year"))



```

